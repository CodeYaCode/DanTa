<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.snda.cloud.virtulization.resource.dao.IReservedInstanceDao">
	<resultMap type="reservedInstance" id="reservedInstance">
		<result property="riId" column="RI_ID" />
		<result property="userId" column="USER_ID" />
		<result property="riInfoId" column="RI_INFO_ID" />
		<result property="enabled" column="ENABLED" />
		<result property="duration" column="COUNT_TYPE" />
		<result property="startTime" column="START_TIME" />
		<result property="endTime" column="END_TIME" />
	</resultMap>
	
	<select id="selectReservedInstanceByCondition" parameterType="reservedInstance" resultMap="reservedInstance">
		SELECT
			A.RI_ID, A.USER_ID, A.RI_INFO_ID, A.ENABLED, A.START_TIME, A.END_TIME, B.COUNT_TYPE
		FROM
			RESERVED_INSTANCE A, RESERVED_INSTANCE_INFO B
		WHERE
			A.ENABLED = 1
		AND
			A.IS_DELETED = 0
		AND
			A.RI_INFO_ID = B.RI_INFO_ID
		<if test="riId != null">
		AND
			A.RI_ID = #{riId}
		</if>
		<if test="userId != null">
		AND
			A.USER_ID = #{userId}
		</if>
		<if test="riInfoId != null">
		AND
			A.RI_INFO_ID = #{riInfoId}
		</if>
		<if test="flag != null">
		AND
			A.RI_ID
		IN
			(
			SELECT
				COUNT_TYPE AS RI_ID
			FROM
				VM_INFO
			WHERE
				IS_DELETED = 0
			AND
				IS_ENABLED = 1
			AND
				COUNT_TYPE != ''
			)
		</if>
	</select>
	
	<select id="selectReservedInstanceByRIIds" parameterType="list" resultMap="reservedInstance">
		SELECT
			A.RI_ID, A.USER_ID, A.RI_INFO_ID, A.ENABLED, A.START_TIME, A.END_TIME, B.COUNT_TYPE
		FROM
			RESERVED_INSTANCE A, RESERVED_INSTANCE_INFO B
		WHERE
			A.ENABLED = 1
		AND
			A.IS_DELETED = 0
		AND
			A.RI_INFO_ID = B.RI_INFO_ID
		AND
			A.RI_ID
		IN
		<foreach collection="list" item="riId" open="(" close=")" separator=",">
			#{riId}
		</foreach>
	</select>
	
	<select id="selectUsingReservedInstanceIds" resultType="String">
		SELECT
			COUNT_TYPE
		FROM
			VM_INFO
		WHERE
			IS_DELETED = 0
		AND
			IS_ENABLED = 1
		AND
			COUNT_TYPE != ''
	</select>
	
</mapper>